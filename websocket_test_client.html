<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Task Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        .controls {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background-color: #f8f8f8;
        }
        #log {
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f5f5f5;
            font-family: monospace;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        input[type=text], input[type=number] {
            padding: 8px;
            margin: 5px;
            width: 300px;
        }
        .json {
            color: #0000ff;
        }
        .error {
            color: #ff0000;
        }
        .success {
            color: #008800;
        }
    </style>
</head>
<body>
    <h1>WebSocket Task Test</h1>
    
    <div class="controls">
        <h3>Connection</h3>
        <div>
            <label for="token">JWT Token:</label><br>
            <input type="text" id="token" placeholder="Paste your JWT token here" size="50" /><br>
            <button onclick="connect()">Connect WebSocket</button>
            <button onclick="disconnect()">Disconnect</button>
        </div>
        <div>
            <b>Connection Status:</b> <span id="status">Disconnected</span>
        </div>
    </div>
    
    <div class="controls">
        <h3>Task Testing</h3>
        <div>
            <button onclick="testRedisMessage()">Test Redis Message</button>
            <button onclick="submitRandomTask()">Generate Random Number</button>
            <button onclick="submitReverseTask()">Reverse String</button>
        </div>
        <div>
            <label for="min">Min Value:</label>
            <input type="number" id="min" value="1" min="1" max="999" />
            
            <label for="max">Max Value:</label>
            <input type="number" id="max" value="100" min="2" max="999" />
        </div>
        <div>
            <label for="text">Text to Reverse:</label>
            <input type="text" id="text" value="Hello World!" />
        </div>
    </div>
    
    <h3>Event Log</h3>
    <div id="log"></div>
    
    <script>
        let socket = null;
        
        function log(message, className = '') {
            const logElement = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            
            if (typeof message === 'object') {
                try {
                    message = JSON.stringify(message, null, 2);
                    className = 'json';
                } catch (e) {
                    message = message.toString();
                }
            }
            
            logElement.innerHTML += `<div class="${className}">[${now}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function formatJSON(json) {
            try {
                if (typeof json === 'string') {
                    const obj = JSON.parse(json);
                    return JSON.stringify(obj, null, 2);
                } else {
                    return JSON.stringify(json, null, 2);
                }
            } catch (e) {
                return json;
            }
        }
        
        function connect() {
            if (socket) {
                log('Already connected');
                return;
            }
            
            const token = document.getElementById('token').value;
            if (!token) {
                log('Please enter a token', 'error');
                return;
            }
            
            // Fix the URL construction to use absolute URL
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            // Use "localhost:8000" directly for testing
            const wsUrl = `${wsProtocol}//localhost:8000/ws/notifications/?token=${token}`;
            log(`Connecting to ${wsUrl}`);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function() {
                document.getElementById('status').innerText = 'Connected';
                document.getElementById('status').style.color = 'green';
                log('Connection established!', 'success');
            };
            
            socket.onmessage = function(event) {
                log(`Message received: ${event.data}`);
                try {
                    const data = JSON.parse(event.data);
                    log(data);
                    
                    if (data.type === 'task_result') {
                        log('Task result received!', 'success');
                    } else if (data.type === 'error') {
                        log(`Error: ${data.message}`, 'error');
                    }
                } catch (e) {
                    log(`Error parsing message: ${e}`, 'error');
                }
            };
            
            socket.onclose = function(event) {
                document.getElementById('status').innerText = 'Disconnected';
                document.getElementById('status').style.color = 'red';
                
                if (event.wasClean) {
                    log(`Connection closed cleanly, code=${event.code}, reason=${event.reason}`);
                } else {
                    log('Connection died', 'error');
                }
                
                socket = null;
            };
            
            socket.onerror = function(error) {
                log(`WebSocket Error: ${error}`, 'error');
            };
        }
        
        function disconnect() {
            if (!socket) {
                log('Not connected');
                return;
            }
            
            socket.close();
            log('Disconnected');
            document.getElementById('status').innerText = 'Disconnected';
            document.getElementById('status').style.color = 'red';
        }
        
        function getUserIdFromToken(token) {
            try {
                // Extract the payload part of the JWT
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Not a valid JWT token');
                }
                
                // Base64 decode and parse JSON
                const payload = JSON.parse(atob(parts[1]));
                return payload.user_id;
            } catch (e) {
                log(`Error extracting user_id from token: ${e}`, 'error');
                return null;
            }
        }
        
        function testRedisMessage() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('Please enter a token', 'error');
                return;
            }
            
            const userId = getUserIdFromToken(token);
            if (!userId) {
                log('Could not extract user_id from token', 'error');
                return;
            }
            
            log(`Sending test message to Redis for user ${userId}...`);
            
            fetch(`http://localhost:8000/api/tasks/test-redis/?user_id=${userId}&message=Test from WebSocket client at ${new Date().toISOString()}`)
                .then(response => response.json())
                .then(data => {
                    log('Redis test response:', 'success');
                    log(data);
                })
                .catch(error => {
                    log(`Error testing Redis: ${error}`, 'error');
                });
        }
        
        function submitRandomTask() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('Please enter a token', 'error');
                return;
            }
            
            const minValue = document.getElementById('min').value;
            const maxValue = document.getElementById('max').value;
            
            if (parseInt(minValue) >= parseInt(maxValue)) {
                log('Min value must be less than max value', 'error');
                return;
            }
            
            log(`Submitting random number task (min=${minValue}, max=${maxValue})...`);
            
            fetch('http://localhost:8000/api/tasks/generate_random_number/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    min_value: parseInt(minValue),
                    max_value: parseInt(maxValue)
                })
            })
            .then(response => response.json())
            .then(data => {
                log('Task submission response:', 'success');
                log(data);
            })
            .catch(error => {
                log(`Error submitting task: ${error}`, 'error');
            });
        }
        
        function submitReverseTask() {
            const token = document.getElementById('token').value;
            if (!token) {
                log('Please enter a token', 'error');
                return;
            }
            
            const text = document.getElementById('text').value;
            if (!text) {
                log('Please enter text to reverse', 'error');
                return;
            }
            
            log(`Submitting reverse string task (text="${text}")...`);
            
            fetch('http://localhost:8000/api/tasks/reverse_string/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    text: text
                })
            })
            .then(response => response.json())
            .then(data => {
                log('Task submission response:', 'success');
                log(data);
            })
            .catch(error => {
                log(`Error submitting task: ${error}`, 'error');
            });
        }
    </script>
</body>
</html>
